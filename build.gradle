/*
 * This file was generated by the Gradle 'init' task.
 *
 * This is a general purpose Gradle build.
 * To learn more about Gradle by exploring our Samples at https://docs.gradle.org/8.7/samples
 *
 * Generated by m30pm during project creation.
 */
plugins {
    id 'base'
}

def packageJson = "$projectDir/package.json"
def packageYaml = "$buildDir/package.yaml"
def unifiedModelBuildPath = "$buildDir/unifiedModel.yaml"
def schemaFileName = "resume-schema.yaml"
def schemaSrcDir = "$projectDir/model/schema"
def schemaOutDir = "schema"
def schemaBuildDir = "$buildDir/$schemaOutDir"
def unifiedSchemaPath = "$schemaBuildDir/$schemaFileName"
def modelSrc = "$projectDir/model/resume-model.yaml"
def modelBuildFileName = "model.json"
def modelSrcDirName = "model/resume"
def modelSrcDir = "$projectDir/$modelSrcDirName"
def modelSrcExt = ".yaml"
def modelBuildDirName = "$modelSrcDirName"
def modelBuildDir = "$buildDir/$modelBuildDirName"
def modelBuildExt = ".json"
def querySrcFileName = "resume.adoc.njk"
def querySrc = "$projectDir/views/resume.adoc.njk"
def querySrcDirName = "views/"
def querySrcDir = "$projectDir/$querySrcDirName"
def queryBuildDirName = "$querySrcDirName"
def queryBuildDir = "$buildDir/$queryBuildDirName"
def queryBuildExt = ".adoc"
def viewBuild = "$buildDir/resume.adoc"

tasks.register('buildUnifiedSchema', Exec) {
    inputs.files(fileTree("$schemaSrcDir"))
        .withPropertyName('sourceFiles')
        .withPathSensitivity(PathSensitivity.ABSOLUTE)
    outputs.dir(layout.buildDirectory.dir("$schemaOutDir"))
        .withPropertyName('outputDir')
    commandLine "bash", "-c", "gen-yaml $schemaSrcDir/$schemaFileName --mergeimports > $unifiedSchemaPath"
}

tasks.register('cleanupUnifiedSchema', Exec) {
    dependsOn(buildUnifiedSchema)
    inputs.files(fileTree("$schemaOutDir"))
        .withPropertyName('sourceFiles')
        .withPathSensitivity(PathSensitivity.ABSOLUTE)
    outputs.dir(layout.buildDirectory.dir("$schemaOutDir"))
        .withPropertyName('outputDir')
    commandLine "yq", "-i", "del(.imports)", "$unifiedSchemaPath"
}

 tasks.register('makePackageJsonYaml', Exec) {
    dependsOn(cleanupUnifiedSchema)
    inputs.files(fileTree("$modelSrcDir"))
    .withPathSensitivity(PathSensitivity.ABSOLUTE)
    outputs.dir(layout.buildDirectory.dir("$modelBuildDir"))
    commandLine "bash", "-c", "yq -p json -o yaml $packageJson > $packageYaml"
}

 tasks.register('buildModel', Exec) {
    dependsOn(makePackageJsonYaml)
    inputs.files(fileTree("$modelSrcDir"))
    .withPathSensitivity(PathSensitivity.ABSOLUTE)
    //commandLine "bash", "-c", "cat $modelSrc >> $unifiedModelBuildPath"
    //commandLine "bash", "-c", "yq eval-all '. as \$item ireduce ({}; . * \$item)' $packageYaml $modelSrc > $unifiedModelBuildPath"
    commandLine "bash", "-c", "cat $packageYaml > $unifiedModelBuildPath && cat $modelSrc >> $unifiedModelBuildPath"

}

tasks.register('validateModel', Exec) {
    dependsOn(buildModel)
    inputs.files(fileTree("$modelSrcDir"))
    .withPathSensitivity(PathSensitivity.ABSOLUTE)
    commandLine "linkml-validate", "-s", "$schemaBuildDir/$schemaFileName", "$modelSrc"
}

tasks.register('buildView', Exec) {
    dependsOn(validateModel)
    inputs.files(fileTree("$modelBuildDir"))
        .withPathSensitivity(PathSensitivity.ABSOLUTE)
    outputs.dir(layout.buildDirectory.dir("$queryBuildDir"))
    commandLine "bash", "-c", "npm exec -- nunjucks -d $unifiedModelBuildPath $querySrc > $viewBuild"
}

tasks.named("assemble") {
    dependsOn(buildView)
}
